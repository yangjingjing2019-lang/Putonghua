<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™®é€šè©± j q x æœ—è®€æŒ‘æˆ°</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; text-align: center; background: #f3e5f5; padding: 20px; color: #333; margin: 0; }
    /* å•Ÿå‹•é®ç½© */
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(123, 31, 162, 0.9); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
    #overlay button { padding: 20px 40px; font-size: 24px; background: #ffeb3b; color: #4a148c; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; }
    
    .container { max-width: 700px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); position: relative; min-height: 520px; }
    h1 { color: #7b1fa2; font-size: 24px; }
    .word-box { font-size: 80px; color: #4a148c; margin: 20px 0; padding: 20px; border: 4px dashed #e1bee7; border-radius: 15px; background: #fafafa; }
    .info { font-size: 18px; margin: 10px 0; color: #666; }
    button { margin: 10px; padding: 15px 35px; font-size: 20px; cursor: pointer; border: none; border-radius: 50px; transition: 0.3s; font-weight: bold; }
    .play-btn { background: #9c27b0; color: white; }
    .record-btn { background: #e91e63; color: white; }
    .record-btn.active { background: #9e9e9e; animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.6; } }
    
    .nav-btn { position: absolute; bottom: 20px; background: #607d8b; color: white; padding: 10px 20px; font-size: 16px; border-radius: 10px; cursor: pointer; }
    .skip-btn { right: 20px; }
    .prev-btn { left: 20px; }
    #result-msg { margin-top: 20px; font-size: 22px; min-height: 40px; font-weight: bold; }
    .stats { display: flex; justify-content: space-around; margin-top: 30px; font-size: 22px; background: #f5f5f5; padding: 15px; border-radius: 10px; }
    .final-screen { display: none; }
  </style>
</head>
<body>

<div id="overlay">
  <h2>æ™®é€šè©± j q x æœ—è®€æ•™å®¤</h2>
  <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹å­¸ç¿’</p>
  <button onclick="initSystem()">é–‹å§‹å­¸ç¿’ ğŸš€</button>
</div>

<div class="container" id="game-container">
  <h1>ğŸ™ï¸ æ™®é€šè©± j q x æœ—è®€æŒ‘æˆ°</h1>
  <p class="info">è«‹æº–ç¢ºæœ—è®€è©èªã€‚ç³»çµ±æ”¯æ´ç¹ç°¡åŠåŒéŸ³å­—è¾¨è­˜ï¼</p>
  
  <div class="stats">
    <div>å¾—åˆ†ï¼š<span id="current-score">0</span></div>
    <div>æ©Ÿæœƒï¼š<span id="chances">3</span></div>
  </div>

  <div class="word-box" id="targetWord">è¼‰å…¥ä¸­...</div>
  
  <button class="play-btn" id="playBtn">æ’­æ”¾ç¤ºç¯„éŸ³ ğŸ”Š</button>
  <button class="record-btn" id="recordBtn" onclick="startRecognition()">é–‹å§‹æœ—è®€ ğŸ¤</button>
  
  <div id="result-msg"></div>
  <p id="progress" style="margin-top:20px; color:#888;">é€²åº¦ï¼š1 / 20</p>

  <button class="nav-btn prev-btn" id="prevBtn" onclick="prevWord()">â¬… ä¸Šä¸€é¡Œ</button>
  <button class="nav-btn skip-btn" onclick="skipWord()">ä¸‹ä¸€é¡Œ â”</button>
</div>

<div class="container final-screen" id="final-screen">
  <h1>æ¸¬é©—çµæœ</h1>
  <div id="total-score-display" style="font-size: 60px; font-weight: bold; color: #7b1fa2;"></div>
  <div id="final-msg" style="margin: 30px 0; font-size: 24px; font-weight: bold;"></div>
  <button class="play-btn" onclick="location.reload()">é‡æ–°æŒ‘æˆ° ğŸ”„</button>
</div>

<script>
  // è©åº«æ•¸æ“šï¼št(ç¹é«”), s(ç°¡é«”), h(å¸¸è¦‹åŒéŸ³å­—/èª¤è¾¨å­—)
  const wordData = [
    { t: "ç©æ¥µ", s: "ç§¯æ", h: ["åŸºç´š", "åŸºæ¥µ", "ç©ç©", "åŸºé›†", "æ“Šæ©Ÿ"] },
    { t: "æƒ…æ³", s: "æƒ…å†µ", h: ["æƒ…æ› ", "é ƒæ³", "æ…¶æ³"] },
    { t: "ä¼‘æ¯", "s": "ä¼‘æ¯", h: ["ä¿®ç´°", "ä¼‘ç³»", "ä¿®ç¿’"] },
    { t: "æ©Ÿå™¨", "s": "æœºå™¨", h: ["ç©å™¨", "ç´šå™¨", "åŸºå™¨"] },
    { t: "æƒ…ç·’", "s": "æƒ…ç»ª", h: ["æƒ…åº", "æƒ…çºŒ"] },
    { t: "æ–°é®®", "s": "æ–°é²œ", h: ["å¿ƒé®®", "è¾›é®®"] },
    { t: "æŠ€å·§", "s": "æŠ€å·§", h: ["è¨ˆå·§", "æ—¢å·§"] },
    { t: "ç¢ºå¯¦", "s": "ç¡®å®", h: ["ç¢ºæ™‚", "å»å¯¦"] },
    { t: "è©³ç´°", "s": "è¯¦ç»†", h: ["è©³ç³»", "ç¥¥ç´°"] },
    { t: "èšé›†", "s": "èšé›†", h: ["èšé›†", "å…·é›†"] },
    { t: "å‰é€²", "s": "å‰è¿›", h: ["éŒ¢é€²", "å…¨é€²"] },
    { t: "å¿ƒæƒ³", "s": "å¿ƒæƒ³", h: ["æ–°æƒ³", "æ¬£æƒ³"] },
    { t: "é€²æ­¥", "s": "è¿›æ­¥", h: ["è¿‘æ­¥", "æµ¸æ­¥"] },
    { t: "æ¼†é»‘", "s": "æ¼†é»‘", h: ["ä¸ƒé»‘", "æœŸé»‘"] },
    { t: "ç›¸ä¿¡", "s": "ç›¸ä¿¡", h: ["ç›¸å¿ƒ", "æƒ³ä¿¡"] },
    { t: "è§£æ±º", "s": "è§£å†³", h: ["è§£çµ", "ç¯€æ±º"] },
    { t: "è«‹æ±‚", "s": "è¯·æ±‚", h: ["æƒ…æ±‚", "æ…¶æ±‚"] },
    { t: "è™›å¿ƒ", "s": "è™šå¿ƒ", h: ["éœ€å¿ƒ", "è¨±å¿ƒ"] },
    { t: "å³ä½¿", "s": "å³ä½¿", h: ["æ—¢ä½¿", "ç´šä½¿"] },
    { t: "ç§‹å¤©", "s": "ç§‹å¤©", h: ["ä¸˜å¤©", "ä¿®å¤©"] }
  ];

  let currentIndex = 0;
  let scoresArray = new Array(wordData.length).fill(0);
  let chancesArray = new Array(wordData.length).fill(3);
  let isLevelPassedArray = new Array(wordData.length).fill(false);

  let synth = window.speechSynthesis;
  let mandarinVoice = null;

  // 1. ç³»çµ±åˆå§‹åŒ–ï¼šè§£æ±ºæ‰‹æ©Ÿç™¼éŸ³å•é¡Œ
  function initSystem() {
    document.getElementById('overlay').style.display = 'none';
    // ç«‹å³å˜—è©¦åŠ è¼‰èªéŸ³æ¸…å–®
    findVoice();
    // æ’­æ”¾ä¸€å€‹å®‰éœçš„ç©ºéŸ³ï¼Œæ¿€æ´» iOS è²é“
    const silent = new SpeechSynthesisUtterance("");
    synth.speak(silent);
  }

  function findVoice() {
    let voices = synth.getVoices();
    // å¼·åˆ¶æœå°‹æ™®é€šè©±
    mandarinVoice = voices.find(v => (v.lang === 'zh-CN' || v.lang === 'zh-Hans-CN') && !v.name.includes('O-ren')) ||
                    voices.find(v => v.name.includes('Mandarin') || v.name.includes('Putonghua')) ||
                    voices.find(v => v.lang.includes('zh') && !v.lang.includes('HK'));
  }

  // ç›£è½èªéŸ³æ¸…å–®è®ŠåŒ–
  if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = findVoice;
  }

  document.getElementById('playBtn').onclick = function() {
    if (synth.speaking) synth.cancel();
    findVoice(); // å†æ¬¡å˜—è©¦å°‹æ‰¾
    const msg = new SpeechSynthesisUtterance(wordData[currentIndex].t);
    msg.lang = 'zh-CN';
    if (mandarinVoice) msg.voice = mandarinVoice;
    msg.rate = 0.8;
    synth.speak(msg);
  };

  // 2. éŒ„éŸ³è¾¨è­˜èˆ‡åŒéŸ³é‚è¼¯
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition ? new SpeechRecognition() : null;
  if(recognition) {
    recognition.lang = 'zh-CN';
    recognition.interimResults = false;
  }

  function startRecognition() {
    if (!recognition) { alert("ç€è¦½å™¨ä¸æ”¯æŒèªéŸ³è¾¨è­˜ï¼Œè«‹ä½¿ç”¨ Chrome/Safari"); return; }
    if (isLevelPassedArray[currentIndex] || chancesArray[currentIndex] <= 0) return;
    
    recognition.start();
    const btn = document.getElementById('recordBtn');
    btn.classList.add('active');
    btn.innerText = "æ­£åœ¨è¾¨è­˜...";

    recognition.onresult = (event) => {
      const studentText = event.results[0][0].transcript;
      btn.classList.remove('active');
      btn.innerText = "é–‹å§‹æœ—è®€ ğŸ¤";
      checkResult(studentText);
    };

    recognition.onerror = () => {
      btn.classList.remove('active');
      btn.innerText = "é–‹å§‹æœ—è®€ ğŸ¤";
    };
  }

  function checkResult(studentText) {
    const target = wordData[currentIndex];
    const resultMsg = document.getElementById('result-msg');
    
    // æ¯”å°é‚è¼¯ï¼š
    // 1. æ¯”å°ç¹é«” 2. æ¯”å°ç°¡é«” 3. æ¯”å°é è¨­åŒéŸ³å­—æ¸…å–®
    const isCorrect = studentText.includes(target.t) || 
                      studentText.includes(target.s) || 
                      target.h.some(homo => studentText.includes(homo));

    if (isCorrect) {
      scoresArray[currentIndex] = 5;
      isLevelPassedArray[currentIndex] = true;
      resultMsg.innerHTML = "<span style='color:green;'>âœ… ç™¼éŸ³æ­£ç¢ºï¼(+5åˆ†)</span>";
      setTimeout(nextWord, 1200);
    } else {
      chancesArray[currentIndex]--;
      resultMsg.innerHTML = chancesArray[currentIndex] > 0 ? 
        `<span style='color:orange;'>âŒ è¾¨è­˜ç‚ºã€Œ${studentText}ã€</span>` : 
        `<span style='color:red;'>æ©Ÿæœƒå·²ç”¨å®Œã€‚</span>`;
    }
    updateDisplay();
  }

  function updateDisplay() {
    document.getElementById('targetWord').innerText = wordData[currentIndex].t;
    document.getElementById('progress').innerText = `é€²åº¦ï¼š${currentIndex + 1} / ${wordData.length}`;
    document.getElementById('chances').innerText = chancesArray[currentIndex];
    document.getElementById('current-score').innerText = scoresArray.reduce((a,b)=>a+b,0);
    document.getElementById('prevBtn').disabled = (currentIndex === 0);
    if (isLevelPassedArray[currentIndex]) document.getElementById('result-msg').innerHTML = "<span style='color:green;'>å·²é€šé âœ…</span>";
  }

  function prevWord() { if (currentIndex > 0) { currentIndex--; updateDisplay(); document.getElementById('result-msg').innerText=""; } }
  function skipWord() { 
    if (currentIndex < wordData.length - 1) { 
      currentIndex++; 
      updateDisplay(); 
      document.getElementById('result-msg').innerText=""; 
    } else { 
      showFinalResult(); 
    } 
  }
  function nextWord() { skipWord(); }

  function showFinalResult() {
    document.getElementById('game-container').style.display = 'none';
    document.getElementById('final-screen').style.display = 'block';
    const total = scoresArray.reduce((a,b)=>a+b,0);
    document.getElementById('total-score-display').innerText = total + " åˆ†";
    let feedback = total < 60 ? "è«‹ç¹¼çºŒåŠ æ²¹ï¼" : (total <= 80 ? "è¡¨ç¾ä¸éŒ¯ï¼Œå†æ¥å†å²ï¼" : "æ­å–œä½ ï¼Œéå¸¸æ£’ï¼");
    document.getElementById('final-msg').innerText = feedback;
  }

  updateDisplay();
</script>
</body>
</html>
